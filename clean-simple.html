<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nettoyage Simple des Points d'Acc√®s</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin: 20px 0; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Nettoyage Simple des Points d'Acc√®s</h1>
        <h2>Suppression des champs S√©curit√©, Canal, Puissance et Signal</h2>
        
        <div class="warning">
            <strong>‚ö†Ô∏è ATTENTION :</strong> Cette op√©ration va supprimer d√©finitivement les champs suivants :
            <ul>
                <li><strong>security</strong> (S√©curit√©)</li>
                <li><strong>channel</strong> (Canal)</li>
                <li><strong>power</strong> (Puissance)</li>
                <li><strong>signalStrength</strong> (Force du signal)</li>
            </ul>
            <strong>Cette action est irr√©versible !</strong>
        </div>

        <div>
            <button onclick="checkAccessPoints()">üîç V√©rifier l'√©tat actuel</button>
            <button onclick="cleanAccessPoints()">üßπ Nettoyer les Points d'Acc√®s</button>
            <button onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBloQQvcd1lMANCU5Frdv7XIFB6vLI74Pk",
            authDomain: "focus-melody-467918-u9.firebaseapp.com",
            projectId: "focus-melody-467918-u9",
            storageBucket: "focus-melody-467918-u9.firebasestorage.app",
            messagingSenderId: "289948248371",
            appId: "1:289948248371:web:089fc30fdeccb2beecf646",
            measurementId: "G-3BFXRCW10N"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function checkAccessPoints() {
            try {
                log('üîç V√©rification de l\'√©tat actuel des points d\'acc√®s...', 'info');
                
                const querySnapshot = await db.collection('accessPoints').get();
                let totalAPs = 0;
                let apsWithOldFields = 0;
                
                querySnapshot.forEach(doc => {
                    totalAPs++;
                    const data = doc.data();
                    if (data.security || data.channel || data.power || data.signalStrength) {
                        apsWithOldFields++;
                        log(`‚ö†Ô∏è ${doc.id}: contient encore des anciens champs`, 'warning');
                    }
                });
                
                log(` R√©sum√©: ${totalAPs} points d'acc√®s au total, ${apsWithOldFields} avec anciens champs`, 'info');
                
                if (apsWithOldFields === 0) {
                    log('‚úÖ Tous les points d\'acc√®s sont d√©j√† nettoy√©s !', 'success');
                } else {
                    log(` ${apsWithOldFields} points d'acc√®s n√©cessitent un nettoyage`, 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erreur lors de la v√©rification: ${error.message}`, 'error');
            }
        }

        async function cleanAccessPoints() {
            try {
                log(' D√©but du nettoyage des points d\'acc√®s...', 'info');
                
                const querySnapshot = await db.collection('accessPoints').get();
                const totalAPs = querySnapshot.size;
                let cleanedAPs = 0;
                
                if (totalAPs === 0) {
                    log('‚ÑπÔ∏è Aucun point d\'acc√®s trouv√©', 'info');
                    return;
                }
                
                log(` ${totalAPs} points d'acc√®s trouv√©s, d√©but du nettoyage...`, 'info');
                
                // Traiter chaque document individuellement
                for (const doc of querySnapshot.docs) {
                    try {
                        const data = doc.data();
                        const docRef = db.collection('accessPoints').doc(doc.id);
                        
                        // Cr√©er un nouvel objet sans les anciens champs
                        const cleanedData = { ...data };
                        delete cleanedData.security;
                        delete cleanedData.channel;
                        delete cleanedData.power;
                        delete cleanedData.signalStrength;
                        
                        // Mettre √† jour le document
                        await docRef.update(cleanedData);
                        cleanedAPs++;
                        log(`‚úÖ ${doc.id} nettoy√©`, 'success');
                    } catch (error) {
                        log(`‚ùå Erreur lors du nettoyage de ${doc.id}: ${error.message}`, 'error');
                    }
                }
                
                log(`‚úÖ Nettoyage termin√© ! ${cleanedAPs} points d'acc√®s nettoy√©s`, 'success');
                log('üîÑ Les champs security, channel, power et signalStrength ont √©t√© supprim√©s', 'success');
                
                // V√©rifier le r√©sultat
                await checkAccessPoints();
                
            } catch (error) {
                log(`‚ùå Erreur lors du nettoyage: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }

        // V√©rification automatique au chargement
        window.addEventListener('load', () => {
            log('üöÄ Script de nettoyage simple charg√©', 'info');
            log('üìã Cliquez sur "V√©rifier l\'√©tat actuel" pour commencer', 'info');
        });
    </script>
</body>
</html>