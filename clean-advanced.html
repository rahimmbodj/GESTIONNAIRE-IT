<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic et Nettoyage Avanc√© des Points d'Acc√®s</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 5px; margin: 20px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin: 20px 0; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .progress { background: #e9ecef; border-radius: 5px; height: 20px; margin: 20px 0; overflow: hidden; }
        .progress-bar { background: #007bff; height: 100%; width: 0%; transition: width 0.3s ease; }
        .details { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .field-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .field-item { background: #e9ecef; padding: 8px; border-radius: 5px; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>   Diagnostic et Nettoyage Avanc√© des Points d'Acc√®s</h1>
        <h2>Suppression des champs S√©curit√©, Canal, Puissance et Signal</h2>
        
        <div class="warning">
            <strong>‚ö†Ô∏è ATTENTION :</strong> Cette op√©ration va supprimer d√©finitivement les champs suivants :
            <ul>
                <li><strong>security</strong> (S√©curit√©)</li>
                <li><strong>channel</strong> (Canal)</li>
                <li><strong>power</strong> (Puissance)</li>
                <li><strong>signalStrength</strong> (Force du signal)</li>
            </ul>
            <strong>Cette action est irr√©versible !</strong>
        </div>

        <div>
            <button onclick="diagnoseAccessPoints()">   Diagnostic Complet</button>
            <button onclick="cleanAccessPoints()">üßπ Nettoyer TOUS les Points d'Acc√®s</button>
            <button onclick="cleanOneByOne()">   Nettoyer Un par Un</button>
            <button onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
        </div>

        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="details" id="details" style="display: none;">
            <h3>   D√©tails des Champs √† Supprimer</h3>
            <div id="fieldDetails"></div>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBloQQvcd1lMANCU5Frdv7XIFB6vLI74Pk",
            authDomain: "focus-melody-467918-u9.firebaseapp.com",
            projectId: "focus-melody-467918-u9",
            storageBucket: "focus-melody-467918-u9.firebasestorage.app",
            messagingSenderId: "289948248371",
            appId: "1:289948248371:web:089fc30fdeccb2beecf646",
            measurementId: "G-3BFXRCW10N"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`); // Log aussi dans la console
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('details').style.display = 'none';
        }

        async function diagnoseAccessPoints() {
            try {
                log('üîç D√©but du diagnostic complet des points d\'acc√®s...', 'info');
                
                const querySnapshot = await db.collection('accessPoints').get();
                let totalAPs = 0;
                let apsWithOldFields = 0;
                let fieldStats = { security: 0, channel: 0, power: 0, signalStrength: 0 };
                let problematicDocs = [];
                
                querySnapshot.forEach(doc => {
                    totalAPs++;
                    const data = doc.data();
                    let hasOldFields = false;
                    let docFields = [];
                    
                    if (data.security) { fieldStats.security++; hasOldFields = true; docFields.push('security'); }
                    if (data.channel) { fieldStats.channel++; hasOldFields = true; docFields.push('channel'); }
                    if (data.power) { fieldStats.power++; hasOldFields = true; docFields.push('power'); }
                    if (data.signalStrength) { fieldStats.signalStrength++; hasOldFields = true; docFields.push('signalStrength'); }
                    
                    if (hasOldFields) {
                        apsWithOldFields++;
                        problematicDocs.push({ id: doc.id, fields: docFields, data: data });
                        log(`‚ö†Ô∏è ${doc.id}: contient ${docFields.join(', ')}`, 'warning');
                    }
                });
                
                log(`   R√âSUM√â DIAGNOSTIC:`, 'info');
                log(`   Total: ${totalAPs} points d'acc√®s`, 'info');
                log(`   Avec anciens champs: ${apsWithOldFields}`, 'warning');
                log(`   Champs trouv√©s:`, 'info');
                log(`     - security: ${fieldStats.security}`, 'info');
                log(`     - channel: ${fieldStats.channel}`, 'info');
                log(`     - power: ${fieldStats.power}`, 'info');
                log(`     - signalStrength: ${fieldStats.signalStrength}`, 'info');
                
                // Afficher les d√©tails
                if (problematicDocs.length > 0) {
                    const detailsDiv = document.getElementById('details');
                    const fieldDetailsDiv = document.getElementById('fieldDetails');
                    
                    let detailsHTML = '<div class="field-list">';
                    problematicDocs.slice(0, 20).forEach(doc => {
                        detailsHTML += `<div class="field-item">${doc.id}: ${doc.fields.join(', ')}</div>`;
                    });
                    if (problematicDocs.length > 20) {
                        detailsHTML += `<div class="field-item">... et ${problematicDocs.length - 20} autres</div>`;
                    }
                    detailsHTML += '</div>';
                    
                    fieldDetailsDiv.innerHTML = detailsHTML;
                    detailsDiv.style.display = 'block';
                }
                
            } catch (error) {
                log(`‚ùå Erreur lors du diagnostic: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }

        async function cleanAccessPoints() {
            try {
                log('   D√©but du nettoyage MASSIF de tous les points d\'acc√®s...', 'info');
                
                const querySnapshot = await db.collection('accessPoints').get();
                const totalAPs = querySnapshot.size;
                let cleanedAPs = 0;
                let errors = 0;
                
                if (totalAPs === 0) {
                    log('‚ÑπÔ∏è Aucun point d\'acc√®s trouv√©', 'info');
                    return;
                }
                
                log(`   ${totalAPs} points d'acc√®s trouv√©s, d√©but du nettoyage...`, 'info');
                
                // Utiliser un batch pour les mises √† jour
                const batch = db.batch();
                let batchCount = 0;
                const BATCH_LIMIT = 500; // Limite Firestore
                
                for (const doc of querySnapshot.docs) {
                    try {
                        const data = doc.data();
                        const docRef = db.collection('accessPoints').doc(doc.id);
                        
                        // Cr√©er un nouvel objet sans les anciens champs
                        const cleanedData = { ...data };
                        delete cleanedData.security;
                        delete cleanedData.channel;
                        delete cleanedData.power;
                        delete cleanedData.signalStrength;
                        
                        // Ajouter la mise √† jour au batch
                        batch.update(docRef, cleanedData);
                        batchCount++;
                        cleanedAPs++;
                        
                        // Si le batch est plein, l'ex√©cuter
                        if (batchCount >= BATCH_LIMIT) {
                            log(`   Ex√©cution du batch ${Math.ceil(cleanedAPs / BATCH_LIMIT)}...`, 'info');
                            await batch.commit();
                            batchCount = 0;
                        }
                        
                    } catch (error) {
                        log(`‚ùå Erreur lors du nettoyage de ${doc.id}: ${error.message}`, 'error');
                        errors++;
                    }
                }
                
                // Ex√©cuter le dernier batch
                if (batchCount > 0) {
                    log(`üíæ Ex√©cution du dernier batch...`, 'info');
                    await batch.commit();
                }
                
                log(`‚úÖ NETTOYAGE MASSIF TERMIN√â !`, 'success');
                log(`   Points d'acc√®s nettoy√©s: ${cleanedAPs}`, 'success');
                log(`   Erreurs: ${errors}`, errors > 0 ? 'error' : 'success');
                log(`   Champs supprim√©s: security, channel, power, signalStrength`, 'success');
                
                // V√©rifier le r√©sultat
                await diagnoseAccessPoints();
                
            } catch (error) {
                log(`‚ùå Erreur lors du nettoyage massif: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }

        async function cleanOneByOne() {
            try {
                log('   D√©but du nettoyage un par un (plus lent mais plus s√ªr)...', 'info');
                
                const querySnapshot = await db.collection('accessPoints').get();
                const totalAPs = querySnapshot.size;
                let cleanedAPs = 0;
                let errors = 0;
                
                if (totalAPs === 0) {
                    log('‚ÑπÔ∏è Aucun point d\'acc√®s trouv√©', 'info');
                    return;
                }
                
                log(`   ${totalAPs} points d'acc√®s trouv√©s, nettoyage un par un...`, 'info');
                
                for (const doc of querySnapshot.docs) {
                    try {
                        const data = doc.data();
                        const docRef = db.collection('accessPoints').doc(doc.id);
                        
                        // Cr√©er un nouvel objet sans les anciens champs
                        const cleanedData = { ...data };
                        delete cleanedData.security;
                        delete cleanedData.channel;
                        delete cleanedData.power;
                        delete cleanedData.signalStrength;
                        
                        // Mettre √† jour le document
                        await docRef.update(cleanedData);
                        cleanedAPs++;
                        
                        if (cleanedAPs % 10 === 0) {
                            log(`‚úÖ ${cleanedAPs}/${totalAPs} points d'acc√®s nettoy√©s...`, 'info');
                        }
                        
                    } catch (error) {
                        log(`‚ùå Erreur lors du nettoyage de ${doc.id}: ${error.message}`, 'error');
                        errors++;
                    }
                }
                
                log(`‚úÖ NETTOYAGE UN PAR UN TERMIN√â !`, 'success');
                log(`   Points d'acc√®s nettoy√©s: ${cleanedAPs}`, 'success');
                log(`   Erreurs: ${errors}`, errors > 0 ? 'error' : 'success');
                
                // V√©rifier le r√©sultat
                await diagnoseAccessPoints();
                
            } catch (error) {
                log(`‚ùå Erreur lors du nettoyage un par un: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }

        // V√©rification automatique au chargement
        window.addEventListener('load', () => {
            log('üöÄ Outil de diagnostic et nettoyage avanc√© charg√©', 'info');
            log('üìã Commencez par "Diagnostic Complet" pour analyser la situation', 'info');
        });
    </script>
</body>
</html>